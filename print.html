<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” Ù…Ø¶Ø¨ÙˆØ· A4 (Ø³Ø¹Ø± Ù…Ù„Ø§ØµÙ‚ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯)</title>

  <!-- JsBarcode CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <style>
    @page { size: A4 portrait; margin: 10mm; }

    :root{
      --grid-gap: 3mm;
      --barcode-height: 9mm;
      --price-height: 6mm;
      --item-padding: 2mm;
      --header-height: 12mm;
      --footer-height: 8mm;
    }

    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; padding:0; font-family: Tahoma, Arial, sans-serif; direction: rtl; }

    header{
      height: var(--header-height);
      padding: 1mm 6mm;
      text-align: center;
      border-bottom: 1px solid #c11;
      display:flex; align-items:center; justify-content:center; flex-direction:column;
    }
    header h1{ margin:0; font-size:14px; }
    #templateInfo{ font-size:11px; color:#444; margin-top:3px; }

    .controls{ text-align:center; margin:6px 0 8px 0; }
    .controls button{ background:#ff0800; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin:3px; }

    main { width:100%; }

    .page { page-break-after: always; display:block; width: calc(100% - 20mm); margin: 0 auto 6mm; }
    .grid{
      display: grid;
      justify-content: center;
      align-content: start;
      gap: var(--grid-gap);
      margin: 0 auto;
    }

    /* ÙƒÙ„ Ø®Ù„ÙŠØ© Ù…Ù†ØªØ¬: Ø´Ø¨ÙƒØ© Ø¯Ø§Ø®Ù„ÙŠØ© Ø¨Ø«Ù„Ø§Ø« ØµÙÙˆÙ:
       1fr (Ø§Ø³Ù… ÙŠØ³ØªØºÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©) - auto (Ø§Ù„Ø³Ø¹Ø± Ù…Ù„Ø§ØµÙ‚) - Ø«Ø§Ø¨Øª (Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯) */
    .item{
      border: 1px solid #111;
      padding: var(--item-padding);
      background:#fff;
      display: grid;
      grid-template-rows: 1fr auto var(--barcode-height);
      gap: 2px;
      overflow: hidden;
      text-align:center;
      align-items: stretch;
      justify-items: center;
    }

    .name{
      margin:0;
      font-size:14px; /* Ø³ÙŠÙØ¹Ø¯Ù„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ */
      line-height:1.05;
      word-break: break-word;
      overflow: hidden;
      width: 100%;
      padding: 0 2mm;
    }

    .price{
      font-size:11px;
      color:#222;
      height: var(--price-height);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 2mm;
      box-sizing: border-box;
      margin: 0;
    }

    .barcode{
      height: var(--barcode-height);
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0;
      box-sizing: border-box;
    }
    .barcode svg{ width:95%; height:100%; display:block; }
    .barcode-fallback{ font-size:10px; color:#666; word-break:break-all; padding:0 2mm; }

    footer{
      height: var(--footer-height);
      text-align:center;
      font-size:11px;
      color:#666;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1mm 6mm;
      box-sizing:border-box;
    }

    @media print{
      .controls { display:none !important; }
      body { margin:0; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
    <div id="templateInfo"></div>
  </header>

  <div class="controls">
    <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <button onclick="window.location.href='index.html'">â†©ï¸ Ø±Ø¬ÙˆØ¹</button>
  </div>

  <main id="container"></main>

  <footer id="footerText"></footer>

  <script>
    (function(){
      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª A4 ÙˆØ­Ø³Ø§Ø¨Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø©
      const A4_W = 210, A4_H = 297;
      const MARGIN = 10; // Ù…Ø·Ø§Ø¨Ù‚ @page
      const HEADER = 12, FOOTER = 8;
      const GAP = 3; // mm
      const ROWS = 7, COLS = 3;
      const BARCODE_MM = 9, PRICE_MM = 6, ITEM_PADDING_MM = 2;

      const PX_PER_MM = 96 / 25.4;
      function mmToPx(mm){ return Math.round(mm * PX_PER_MM); }

      const printableH = A4_H - 2 * MARGIN - HEADER - FOOTER;
      const totalGapsV = (ROWS - 1) * GAP;
      const itemH = (printableH - totalGapsV) / ROWS; // mm per item

      const printableW = A4_W - 2 * MARGIN;
      const totalGapsH = (COLS - 1) * GAP;
      const colW = (printableW - totalGapsH) / COLS;

      // Ø¶Ø¨Ø· Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙÙŠ CSS
      const root = document.documentElement;
      root.style.setProperty('--grid-gap', GAP + 'mm');
      root.style.setProperty('--barcode-height', BARCODE_MM + 'mm');
      root.style.setProperty('--price-height', PRICE_MM + 'mm');
      root.style.setProperty('--item-padding', ITEM_PADDING_MM + 'mm');

      // Ù†Ø¶Ø¨Ø· Ø´Ø¨ÙƒØ§Øª Ø§Ù„ØµÙØ­Ø§Øª: ÙƒÙ„ ØµÙØ­Ø© grid Ø«Ø§Ø¨ØªØ© 3 Ø£Ø¹Ù…Ø¯Ø© Ã— 7 ØµÙÙˆÙ
      // Ù†Ø³ØªØ®Ø¯Ù… style inline Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¨Ø¯Ù‚Ø©
      const STORAGE_KEY = 'print_items_v2';
      const container = document.getElementById('container');
      const infoEl = document.getElementById('templateInfo');
      const footerEl = document.getElementById('footerText');

      function safeParse(json){ try{ return JSON.parse(json); } catch(e){ return null; } }

      // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† JsBarcode
      function ensureJsBarcode(){
        return new Promise((resolve,reject)=>{
          if (typeof JsBarcode !== 'undefined') return resolve();
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
          s.onload = () => resolve();
          s.onerror = () => reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ JsBarcode'));
          document.head.appendChild(s);
        });
      }

      // fit text: ÙŠØµØºØ± Ø§Ù„Ø®Ø· Ø­ØªÙ‰ ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©
      function fitTextToElement(el, { maxSizePx = 16, minSizePx = 7, step = 0.5 } = {}){
        if (!el) return;
        let size = maxSizePx;
        el.style.fontSize = size + 'px';
        el.style.lineHeight = '1.05';
        el.style.whiteSpace = 'normal';
        // safety limit
        let safety = 200;
        while (el.scrollHeight > el.clientHeight && size > minSizePx && safety-- > 0){
          size = Math.max(minSizePx, +(size - step).toFixed(2));
          el.style.fontSize = size + 'px';
        }
      }

      // fallback barcode gener
      function hashCode(s){
        let h = 0;
        for (let i=0;i<s.length;i++){ h = ((h<<5)-h)+s.charCodeAt(i); h |= 0; }
        return Math.abs(h);
      }
      function tryGenerateBarcode(svgEl, item, fallbackIndex){
        if (!svgEl || typeof JsBarcode === 'undefined') return false;
        const candidates = [];
        if (item && item.barcode) candidates.push(String(item.barcode));
        if (item && item.scale) candidates.push(String(item.scale));
        if (item && item.sku) candidates.push(String(item.sku));
        if (item && item.id) candidates.push(String(item.id));
        for (const c of candidates){
          if (!c) continue;
          try{
            JsBarcode(svgEl, c, { format:'CODE128', displayValue:false, height: mmToPx(BARCODE_MM), width:1.0, margin:0 });
            return true;
          }catch(e){}
        }
        // digits-only attempt
        for (const c of candidates){
          const d = String(c).replace(/\D/g,'');
          if (d.length >= 6){
            try{ JsBarcode(svgEl, d, { format:'CODE128', displayValue:false, height:mmToPx(BARCODE_MM), width:1.0, margin:0}); return true; }catch(e){}
          }
        }
        // fallback from name
        const fallback = 'P' + String(hashCode((item && item.name) || String(fallbackIndex))).padStart(12,'0').slice(-12);
        try{ JsBarcode(svgEl, fallback, { format:'CODE128', displayValue:false, height:mmToPx(BARCODE_MM), width:1.0, margin:0 }); return true; }catch(e){}
        return false;
      }

      // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw){
        container.innerHTML = '<p style="text-align:center;color:red;padding:12px">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©. Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª JSON ÙÙŠ localStorage Ø¨Ø§Ù„Ù…ÙØªØ§Ø­: ' + STORAGE_KEY + '</p>';
        infoEl.textContent = '';
        footerEl.textContent = '';
        return;
      }
      const payload = safeParse(raw);
      if (!payload || !Array.isArray(payload.items)){
        container.innerHTML = '<p style="text-align:center;color:red;padding:12px">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ø£Ùˆ Ù…ÙÙ‚ÙˆØ¯Ø©.</p>';
        infoEl.textContent = '';
        footerEl.textContent = '';
        return;
      }

      const items = payload.items;
      infoEl.textContent = `Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø±Ù‚Ù…: ${payload.templateNumber || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} â€” Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${items.length}`;
      footerEl.textContent = `ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(payload.generatedAt || Date.now()).toLocaleString('ar-EG')}`;

      // Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø§Øª
      ensureJsBarcode().catch((err)=>{ console.warn(err && err.message ? err.message : err); }).finally(()=>{
        const CHUNK = ROWS * COLS; //21
        const pages = Math.ceil(items.length / CHUNK);

        for (let p = 0; p < pages; p++){
          const chunk = items.slice(p * CHUNK, p * CHUNK + CHUNK);
          const page = document.createElement('section');
          page.className = 'page';

          const grid = document.createElement('div');
          grid.className = 'grid';
          // Ø§Ø¶Ø¨Ø· Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø´Ø¨ÙƒØ© Ø¨Ø¯Ù‚Ø© (inline style)
          grid.style.gridTemplateColumns = `repeat(${COLS}, ${colW.toFixed(4)}mm)`;
          grid.style.gridTemplateRows = `repeat(${ROWS}, ${itemH.toFixed(4)}mm)`;
          grid.style.gap = GAP + 'mm';
          grid.style.width = `calc(${(colW * COLS).toFixed(4)}mm + ${(COLS-1)*GAP}mm)`;

          for (let i = 0; i < CHUNK; i++){
            const item = chunk[i];
            const cell = document.createElement('div');
            cell.className = 'item';

            if (item){
              // Ø§Ø³Ù…
              const name = document.createElement('h3');
              name.className = 'name';
              name.textContent = item.name || '-';
              cell.appendChild(name);

              // Ø§Ù„Ø³Ø¹Ø±
              const price = document.createElement('div');
              price.className = 'price';
              price.textContent = `Ø§Ù„Ø³Ø¹Ø±: ${item.price || '-'}`;
              cell.appendChild(price);

              // Ø¨Ø§Ø±ÙƒÙˆØ¯
              const barcodeDiv = document.createElement('div');
              barcodeDiv.className = 'barcode';
              const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
              barcodeDiv.appendChild(svg);
              cell.appendChild(barcodeDiv);
            } else {
              // Ø®Ù„ÙŠØ© ÙØ§Ø±ØºØ© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ®Ø·ÙŠØ·
              const empty = document.createElement('div');
              empty.style.width = '100%';
              empty.style.height = '100%';
              empty.style.background = 'transparent';
              cell.appendChild(empty);
            }

            grid.appendChild(cell);
          }

          page.appendChild(grid);
          container.appendChild(page);
        }

        // Ø¶Ø¨Ø· Ø§Ù„Ù†ØµÙˆØµ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ reflow
        requestAnimationFrame(()=> {
          const allCells = container.querySelectorAll('.item');
          allCells.forEach((cell, idx) => {
            const nameEl = cell.querySelector('.name');
            const svg = cell.querySelector('svg');
            // ØªØµØºÙŠØ± Ø§Ù„Ù†Øµ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø®Ù„ÙŠØ©
            if (nameEl){
              // Ù†Ø­Ø³Ø¨ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…ØªØ§Ø­ Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ø§Ù†Ø© (Ø£ÙˆÙ„ ØµÙ ÙÙŠ grid)
              // Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ± Ø¶Ù…Ù† grid row1 Ø³ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ clientHeight ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
              fitTextToElement(nameEl, { maxSizePx: 16, minSizePx: 7, step: 0.5 });
            }
            // ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙ‚Ø· Ø¥Ù† ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ù†ØªØ¬
            const actualIdx = idx; // Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ø¨Ø§Ø´Ø± Ù„Ø£Ù†Ù†Ø§ Ø£Ù†Ø´Ø£Ù†Ø§ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹
            const itemData = items[actualIdx];
            if (svg && itemData){
              const ok = tryGenerateBarcode(svg, itemData, actualIdx);
              if (!ok){
                svg.remove();
                const fallback = document.createElement('div');
                fallback.className = 'barcode-fallback';
                fallback.textContent = (itemData && ((itemData.barcode && String(itemData.barcode)) || (itemData.scale && String(itemData.scale)))) || ('#' + (actualIdx + 1));
                const barcodeDiv = cell.querySelector('.barcode');
                if (barcodeDiv) barcodeDiv.appendChild(fallback);
              }
            } else if (svg && !itemData){
              svg.remove();
            }
          });
        });

      });

    })();
  </script>

  <!--
    Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„ØµÙ‚ ÙÙŠ Console Ù‚Ø¨Ù„ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©:
    localStorage.setItem('print_items_v2', JSON.stringify({
      templateNumber: 1,
      generatedAt: Date.now(),
      items: Array.from({length: 21}, (_,i) => ({
        name: i%2===0 ? 'Ù…Ù†ØªØ¬ '+(i+1) : 'Ù…Ù†ØªØ¬ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ù‹Ø§ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙØ§Ù Ø§Ù„Ø£Ø³Ø·Ø± ÙˆØ§Ù„ØªØµØºÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ '+(i+1),
        price: (Math.random()*200).toFixed(2),
        barcode: String(6224008603764 + i)
      }))
    }));
  -->

</body>
</html>
