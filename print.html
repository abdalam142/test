<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>صفحة طباعة المنتجات — إصلاح المسافات</title>

  <!-- JsBarcode CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <style>
    @page { size: A4 portrait; margin: 10mm; }

    :root{
      --grid-gap: 3mm;
      --barcode-mm: 9mm;
      --price-mm: 6mm;
      --item-padding-mm: 2mm;
      --header-mm: 12mm;
      --footer-mm: 8mm;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; margin:0; padding:0; font-family: Tahoma, Arial, sans-serif; direction: rtl; }

    header{
      height: var(--header-mm);
      padding: 1mm 6mm;
      text-align:center;
      border-bottom: 1px solid rgb(38, 0, 253);
      display:flex; align-items:center; justify-content:center; flex-direction:column;
    }
    header h1{ margin:0; font-size:14px; }
    #templateInfo{ font-size:11px; color:#444; margin-top:3px; }

    .controls{ text-align:center; margin:6px 0 8px 0; }
    .controls button{ background:#ff0800; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin:3px; }

    main{ width:100%; }

    .page{ page-break-after: always; display:block; width: calc(100% - 20mm); margin: 0 auto 6mm; }
    .grid{
      display:grid;
      justify-content:center;
      align-content:start;
      gap: var(--grid-gap);
      margin:0 auto;
    }

    /* كل خلية: الاسم في الأعلى (مساحة مرنة) — ثم صندوق سفلي ملتصق للأسفل يحتوى السعر والباركود بدون فراغ */
    .item {
      border:1px solid #111;
      padding: calc(var(--item-padding-mm));
      background: #fff;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      overflow:hidden;
      text-align:center;
    }

    .name {
      margin:0;
      font-size:14px; /* سيتم تعديلها ديناميكياً */
      line-height:1.05;
      word-break:break-word;
      overflow:hidden;
      padding: 0 2mm;
    }

    /* الحاوية السفلية ملتصقة لأسفل العنصر */
    .bottom {
      margin-top: auto; /* الأهم: يجبر السعر والباركود على الالتصاق بأسفل الخلية */
      display:flex;
      flex-direction:column;
      gap:0;
      align-items:center;
      justify-content:flex-end;
    }

    .price {
      font-size:11px;
      color:#222;
      height: var(--price-mm);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 2mm;
      margin:0;
    }

    .barcode {
      height: var(--barcode-mm);
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      box-sizing:border-box;
    }
    .barcode svg{ width:95%; height:100%; display:block; }
    .barcode-fallback{ font-size:10px; color:#666; word-break:break-all; padding:0 2mm; }

    footer{
      height: var(--footer-mm);
      text-align:center;
      font-size:11px;
      color:#666;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1mm 6mm;
      box-sizing:border-box;
    }

    @media print{
      .controls { display:none !important; }
      body { margin:0; }
    }
  </style>
</head>
<body>
  <header>
    <h1>صفحة طباعة المنتجات</h1>
    <div id="templateInfo"></div>
  </header>

  <div class="controls">
    <button onclick="window.print()">🖨️ طباعة</button>
    <button onclick="window.location.href='index.html'">↩️ رجوع</button>
  </div>

  <main id="container"></main>

  <footer id="footerText"></footer>

  <script>
    (function(){
      // قياسات A4 ثابتة بالملم
      const A4_W = 210, A4_H = 297;
      const MARGIN = 10; // مطابق @page
      const HEADER_MM = 12, FOOTER_MM = 8;
      const GAP = 3;
      const ROWS = 7, COLS = 3;
      const BARCODE_MM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--barcode-mm')) || 9;
      const PRICE_MM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--price-mm')) || 6;
      const ITEM_PADDING_MM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--item-padding-mm')) || 2;

      const PX_PER_MM = 96 / 25.4;
      function mmToPx(mm){ return Math.round(mm * PX_PER_MM); }

      // حساب الطول المتاح لكل عنصر
      const printableHeightMM = A4_H - 2 * MARGIN - HEADER_MM - FOOTER_MM;
      const totalGapsVertMM = (ROWS - 1) * GAP;
      const itemHeightMM = (printableHeightMM - totalGapsVertMM) / ROWS;
      const printableWidthMM = A4_W - 2 * MARGIN;
      const totalGapsHorzMM = (COLS - 1) * GAP;
      const colWidthMM = (printableWidthMM - totalGapsHorzMM) / COLS;

      // نفعل المتغيرات في :root لو احتجنا عرضها
      const root = document.documentElement;
      root.style.setProperty('--grid-gap', GAP + 'mm');
      root.style.setProperty('--barcode-mm', BARCODE_MM + 'mm');
      root.style.setProperty('--price-mm', PRICE_MM + 'mm');

      const STORAGE_KEY = 'print_items_v2';
      const container = document.getElementById('container');
      const infoEl = document.getElementById('templateInfo');
      const footerEl = document.getElementById('footerText');

      function safeParse(json){ try{ return JSON.parse(json); } catch(e){ return null; } }

      // تحميل مكتبة JsBarcode عند الحاجة
      function ensureJsBarcode(){
        return new Promise((resolve,reject)=>{
          if (typeof JsBarcode !== 'undefined') return resolve();
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
          s.onload = () => resolve();
          s.onerror = () => reject(new Error('فشل تحميل JsBarcode'));
          document.head.appendChild(s);
        });
      }

      // تقليل الخط حتى يتناسب الاسم مع المساحة المسموح بها
      function fitTextToElement(el, maxHeightPx, { maxSizePx = 16, minSizePx = 7, step = 0.5 } = {}){
        if (!el) return;
        let size = maxSizePx;
        el.style.fontSize = size + 'px';
        el.style.lineHeight = '1.05';
        el.style.whiteSpace = 'normal';
        el.style.overflow = 'hidden';
        el.style.display = 'block';
        // safety
        let safety = 200;
        while ((el.scrollHeight > maxHeightPx || el.clientHeight > maxHeightPx) && size > minSizePx && safety-- > 0){
          size = Math.max(minSizePx, +(size - step).toFixed(2));
          el.style.fontSize = size + 'px';
        }
        // إذا رغم التصغير ظل يفيض، نترك القطع (overflow hidden) — لكن السعر سيبقى ملاصقاً للباركود
      }

      // دوال باركود fallback
      function hashCode(s){
        let h = 0;
        for (let i=0;i<s.length;i++){ h = ((h<<5)-h) + s.charCodeAt(i); h |= 0; }
        return Math.abs(h);
      }
      function tryGenerateBarcode(svgEl, item, fallbackIndex){
        if (!svgEl || typeof JsBarcode === 'undefined') return false;
        const candidates = [];
        if (item && item.barcode) candidates.push(String(item.barcode));
        if (item && item.scale) candidates.push(String(item.scale));
        if (item && item.sku) candidates.push(String(item.sku));
        if (item && item.id) candidates.push(String(item.id));
        for (const c of candidates){
          if (!c) continue;
          try{
            JsBarcode(svgEl, c, { format:'CODE128', displayValue:false, height: mmToPx(BARCODE_MM), width:1.0, margin:0 });
            return true;
          }catch(e){}
        }
        for (const c of candidates){
          const digits = String(c).replace(/\D/g,'');
          if (digits.length >= 6){
            try{ JsBarcode(svgEl, digits, { format:'CODE128', displayValue:false, height:mmToPx(BARCODE_MM), width:1.0, margin:0 }); return true; }catch(e){}
          }
        }
        const fallback = 'P' + String(hashCode(item && item.name ? item.name : String(fallbackIndex))).padStart(12,'0').slice(-12);
        try{ JsBarcode(svgEl, fallback, { format:'CODE128', displayValue:false, height:mmToPx(BARCODE_MM), width:1.0, margin:0 }); return true; }catch(e){}
        return false;
      }

      // قراءة البيانات
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw){
        container.innerHTML = '<p style="text-align:center;color:red;padding:12px">لم يتم العثور على بيانات للطباعة. ضع بيانات JSON في localStorage بالمفتاح: ' + STORAGE_KEY + '</p>';
        infoEl.textContent = '';
        footerEl.textContent = '';
        return;
      }
      const payload = safeParse(raw);
      if (!payload || !Array.isArray(payload.items)){
        container.innerHTML = '<p style="text-align:center;color:red;padding:12px">بيانات الطباعة غير صالحة أو مفقودة.</p>';
        infoEl.textContent = '';
        footerEl.textContent = '';
        return;
      }

      const items = payload.items;
      infoEl.textContent = `القالب رقم: ${payload.templateNumber || 'غير معروف'} — عدد المنتجات: ${items.length}`;
      footerEl.textContent = `تم الإنشاء: ${new Date(payload.generatedAt || Date.now()).toLocaleString('ar-EG')}`;

      // إنشاء الصفحات وجداول 3x7
      ensureJsBarcode().catch(err => console.warn(err && err.message ? err.message : err)).finally(()=>{
        const CHUNK = ROWS * COLS;
        const pages = Math.ceil(items.length / CHUNK);

        for (let p=0; p<pages; p++){
          const chunk = items.slice(p*CHUNK, p*CHUNK + CHUNK);
          const pageEl = document.createElement('section');
          pageEl.className = 'page';

          const grid = document.createElement('div');
          grid.className = 'grid';
          grid.style.gridTemplateColumns = `repeat(${COLS}, ${colWidthMM.toFixed(4)}mm)`;
          grid.style.gridTemplateRows = `repeat(${ROWS}, ${itemHeightMM.toFixed(4)}mm)`;
          grid.style.gap = GAP + 'mm';
          grid.style.width = `calc(${(colWidthMM * COLS).toFixed(4)}mm + ${(COLS-1)*GAP}mm)`;

          for (let i=0; i<CHUNK; i++){
            const actualIdx = p*CHUNK + i;
            const item = items[actualIdx];
            const cell = document.createElement('div');
            cell.className = 'item';
            cell.style.height = itemHeightMM.toFixed(4) + 'mm';
            cell.style.padding = ITEM_PADDING_MM + 'mm';

            if (item){
              const nameEl = document.createElement('h3');
              nameEl.className = 'name';
              nameEl.textContent = item.name || '-';
              // لا نحدد الارتفاع للاسم هنا — سنحسب الحد الأقصى ديناميكياً قبل fit
              cell.appendChild(nameEl);

              const bottom = document.createElement('div');
              bottom.className = 'bottom';

              const priceEl = document.createElement('div');
              priceEl.className = 'price';
              priceEl.textContent = `السعر: ${item.price || '-'}`;
              bottom.appendChild(priceEl);

              const barcodeDiv = document.createElement('div');
              barcodeDiv.className = 'barcode';
              const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
              barcodeDiv.appendChild(svg);
              bottom.appendChild(barcodeDiv);

              cell.appendChild(bottom);
            } else {
              // خلية فارغة
              const empty = document.createElement('div');
              empty.style.width = '100%';
              empty.style.height = '100%';
              empty.style.background = 'transparent';
              cell.appendChild(empty);
            }

            grid.appendChild(cell);
          }

          pageEl.appendChild(grid);
          container.appendChild(pageEl);
        }

        // بعد الإضافة للـ DOM نقوم بعملية إعادة قياس وتعديل حجم الخط وتوليد الباركود
        requestAnimationFrame(() => {
          const allCells = container.querySelectorAll('.page .grid .item');
          allCells.forEach((cell, idx) => {
            const actualIdx = idx; // لأن خلايانا مرتبة تتابعياً عبر الصفحات
            const item = items[actualIdx];
            const nameEl = cell.querySelector('.name');
            const priceEl = cell.querySelector('.price');
            const svg = cell.querySelector('svg');

            if (nameEl){
              // نحسب المساحة المتاحة للاسم: ارتفاع العنصر - (ارتفاع السعر + ارتفاع الباركود) - 2*padding - safety
              const itemHpx = mmToPx(itemHeightMM);
              const priceHpx = mmToPx(PRICE_MM);
              const barcodeHpx = mmToPx(BARCODE_MM);
              const padPx = mmToPx(ITEM_PADDING_MM);
              const safetyPx = Math.round(mmToPx(0.5)); // نصف ملم كفاصل أمان
              const maxNameHpx = Math.max(8, itemHpx - priceHpx - barcodeHpx - (2 * padPx) - safetyPx);

              // طبق limit وقلل الخط حتى يتناسب
              fitTextToElement(nameEl, maxNameHpx, { maxSizePx:16, minSizePx:7, step:0.5 });
              // تأكد من أن عنصر الاسم لا يتجاوز المساحة بالفعل
              nameEl.style.maxHeight = maxNameHpx + 'px';
              nameEl.style.overflow = 'hidden';
            }

            if (svg){
              if (item){
                const ok = tryGenerateBarcode(svg, item, actualIdx);
                if (!ok){
                  svg.remove();
                  const fallback = document.createElement('div');
                  fallback.className = 'barcode-fallback';
                  fallback.textContent = (item && ((item.barcode && String(item.barcode)) || (item.scale && String(item.scale)))) || ('#' + (actualIdx + 1));
                  const barcodeDiv = cell.querySelector('.barcode');
                  if (barcodeDiv) barcodeDiv.appendChild(fallback);
                }
              } else {
                svg.remove();
              }
            }
          });
        });
      });

    })();
  </script>

  <!-- تعليمات اختبار: الصق في Console قبل فتح الملف -->
  <!--
    localStorage.setItem('print_items_v2', JSON.stringify({
      templateNumber: 1,
      generatedAt: Date.now(),
      items: Array.from({length: 21}, (_,i) => ({
        name: i%2===0 ? 'اسم منتج '+(i+1) : 'اسم منتج طويل جدًا لاختبار التفاف الأسطر والتصغير التلقائي حتى لا يسبب فراغ بين السعر والباركود '+(i+1),
        price: (Math.random()*200).toFixed(2),
        barcode: String(6224008603764 + i)
      }))
    }));
  -->

</body>
</html>
