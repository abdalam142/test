<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” Ù…ØµØ­Ø­</title>

  <!-- JsBarcode CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <style>
    /* ØµÙØ­Ø© A4 Ùˆ margins */
    @page { size: A4 portrait; margin: 10mm; }

    :root{
      --safety-mm: 2mm;        /* Ù‡Ø§Ù…Ø´ Ø£Ù…Ø§Ù† Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚Øµ Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙˆØ§Ù */
      --grid-gap: 3mm;
      --barcode-mm: 9mm;
      --price-mm: 3.2mm;      /* Ø­Ø¬Ù… Ø®Ø· Ø§Ù„Ø³Ø¹Ø± Ù…Ø¶Ø¨ÙˆØ· Ø¨Ø§Ù„Ù…Ù„Ù… */
      --price-box-mm: 6mm;    /* Ø§Ø±ØªÙØ§Ø¹ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø³Ø¹Ø± (Ù…Ø³Ø§Ø­Ø© ÙØ¹Ù„ÙŠØ©) */
      --item-padding-mm: 2mm;
      --header-mm: 12mm;
      --footer-mm: 8mm;
    }

    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; padding:0; font-family: Tahoma, Arial, sans-serif; direction: rtl; background:#fff; }

    header{
      height: var(--header-mm);
      padding: 1mm 6mm;
      text-align:center;
      border-bottom:1px solid #c11;
      display:flex; align-items:center; justify-content:center; flex-direction:column;
    }
    header h1{ margin:0; font-size:14px; }
    #templateInfo{ font-size:11px; color:#444; margin-top:3px; }

    .controls{ text-align:center; margin:6px 0 8px 0; }
    .controls button{ background:#ff0800; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin:3px; }

    main{ width:100%; }

    /* container page: Ø³Ù†ØªØ£ÙƒØ¯ Ù…Ù† Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ printableWidth - safety */
    .page { page-break-after: always; display:block; margin: 0 auto 6mm; }

    /* grid Ø³ÙŠÙÙ†Ø´Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¨Ø£Ø¨Ø¹Ø§Ø¯ Ù…Ø­Ø³ÙˆØ¨Ø© Ø¨Ø§Ù„Ù€ JS (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© safety) */
    .grid{ display:grid; justify-content:center; align-content:start; gap: var(--grid-gap); margin:0 auto; }

    /* Ø®Ù„ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬:
       - Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ù…Ø³Ø§Ø­Ø© Ù…Ø±Ù†Ø©)
       - bottom Ù…Ù„ØªØµÙ‚ Ù„Ù„Ø£Ø³ÙÙ„ (price + barcode) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… margin-top:auto
       - height Ø³ÙŠØªÙ… Ø¶Ø¨Ø·Ù‡ inline ÙƒÙ€ mm */
    .item{
      border:1px solid #111;
      padding: calc(var(--item-padding-mm));
      background:#fff;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      overflow:hidden;
      text-align:center;
    }

    .name{
      margin:0;
      font-size:14px;
      line-height:1.05;
      word-break:break-word;
      overflow:hidden;
      padding: 0 2mm;
      /* max-height Ø³ÙŠØ­Ø¯Ø¯ Ø¹Ø¨Ø± JS Ø¨Ø¹Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
    }

    .bottom{
      margin-top:auto; /* Ø§Ù„Ø£Ù‡Ù…: ÙŠÙ„ØµÙ‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø³ÙÙ„ÙŠ Ø¨Ø£Ø³ÙÙ„ Ø§Ù„Ø®Ù„ÙŠØ© */
      display:flex;
      flex-direction:column;
      gap:0;
      align-items:center;
      justify-content:flex-end;
    }

    .price{
      font-size: var(--price-mm); /* Ø­Ø¬Ù… Ø«Ø§Ø¨Øª Ø¨Ø§Ù„Ù€ mm */
      color:#111;
      height: var(--price-box-mm);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 2mm;
      margin:0;
    }

    .barcode{
      height: var(--barcode-mm);
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      box-sizing:border-box;
    }
    .barcode svg{ width:95%; height:100%; display:block; }
    .barcode-fallback{ font-size:10px; color:#666; word-break:break-all; padding:0 2mm; }

    footer{
      height: var(--footer-mm);
      text-align:center;
      font-size:11px;
      color:#666;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1mm 6mm;
      box-sizing:border-box;
    }

    /* Ù„Ø§ ØªØ·Ø¨Ø¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
    @media print {
      .controls { display:none !important; }
      body { margin:0; }
    }

    /* ØªØ¬Ù†Ø¨ ØµÙØ­Ø© ÙØ§Ø±ØºØ© Ø£Ø®ÙŠØ±Ø©: Ù†Ø¬Ø¹Ù„ Ø¢Ø®Ø± ØµÙØ­Ø© Ù„Ø§ ØªÙˆÙ„Ù‘Ø¯ always page-break */
    .page:last-child { page-break-after: auto; }
  </style>
</head>
<body>
  <header>
    <h1>ØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
    <div id="templateInfo"></div>
  </header>

  <div class="controls">
    <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <button onclick="window.location.href='index.html'">â†©ï¸ Ø±Ø¬ÙˆØ¹</button>
  </div>

  <main id="container"></main>

  <footer id="footerText"></footer>

  <script>
    (function(){
      /* Ø«ÙˆØ§Ø¨Øª A4 (mm) */
      const A4_W = 210, A4_H = 297;
      const MARGIN = 10; // Ù†ÙØ³ @page margin
      const HEADER_MM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--header-mm')) || 12;
      const FOOTER_MM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--footer-mm')) || 8;
      const GAP = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-gap')) || 3;
      const ROWS = 7, COLS = 3;

      // safety margin (Ù…Ù†Ø¹ Ø§Ù„Ù‚Øµ)
      const SAFETY_MM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safety-mm')) || 2;

      // barcode/price sizes (Ù…Ù† Ø§Ù„Ù€ CSS root)
      const BARCODE_MM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--barcode-mm')) || 9;
      const PRICE_BOX_MM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--price-box-mm')) || 6;
      const ITEM_PADDING_MM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--item-padding-mm')) || 2;

      // px per mm
      const PX_PER_MM = 96 / 25.4;
      function mmToPx(mm){ return Math.round(mm * PX_PER_MM); }

      // Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¢Ù…Ù†Ø© (Ù†Ø·Ø±Ø­ safety Ù…Ù† printable width)
      const printableWidthMM = A4_W - 2 * MARGIN - SAFETY_MM;
      const printableHeightMM = A4_H - 2 * MARGIN - HEADER_MM - FOOTER_MM;
      const totalGapsV = (ROWS - 1) * GAP;
      const itemHeightMM = (printableHeightMM - totalGapsV) / ROWS;
      const totalGapsH = (COLS - 1) * GAP;
      const colWidthMM = (printableWidthMM - totalGapsH) / COLS;

      // ÙˆØ¶Ø¹ Ù‚ÙŠØ§Ø³Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ø¥Ù„Ù‰ CSS Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… inline Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ±
      const container = document.getElementById('container');
      const infoEl = document.getElementById('templateInfo');
      const footerEl = document.getElementById('footerText');
      const STORAGE_KEY = 'print_items_v2';

      function safeParse(j){ try{ return JSON.parse(j); } catch(e){ return null; } }

      // ØªØ£ÙƒØ¯ Ù…Ù† JsBarcode
      function ensureJsBarcode(){
        return new Promise((resolve,reject)=>{
          if (typeof JsBarcode !== 'undefined') return resolve();
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
          s.onload = () => resolve();
          s.onerror = () => reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ JsBarcode'));
          document.head.appendChild(s);
        });
      }

      // reduce text to fit available height (px)
      function fitTextToElement(el, maxHeightPx, { maxSizePx = 16, minSizePx = 7, step = 0.5 } = {}){
        if (!el) return;
        el.style.fontSize = maxSizePx + 'px';
        el.style.lineHeight = '1.05';
        el.style.whiteSpace = 'normal';
        let size = maxSizePx;
        let safety = 200;
        while ((el.scrollHeight > maxHeightPx || el.clientHeight > maxHeightPx) && size > minSizePx && safety-- > 0){
          size = Math.max(minSizePx, +(size - step).toFixed(2));
          el.style.fontSize = size + 'px';
        }
      }

      function hashCode(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0;} return Math.abs(h); }

      function tryGenerateBarcode(svgEl, item, fallbackIndex){
        if (!svgEl || typeof JsBarcode === 'undefined') return false;
        const candidates = [];
        if (item && item.barcode) candidates.push(String(item.barcode));
        if (item && item.scale) candidates.push(String(item.scale));
        if (item && item.sku) candidates.push(String(item.sku));
        if (item && item.id) candidates.push(String(item.id));
        for (const c of candidates){
          if (!c) continue;
          try{ JsBarcode(svgEl, c, { format:'CODE128', displayValue:false, height: mmToPx(BARCODE_MM), width:1.0, margin:0 }); return true; }catch(e){}
        }
        for (const c of candidates){
          const d = String(c).replace(/\D/g,'');
          if (d.length >= 6){
            try{ JsBarcode(svgEl, d, { format:'CODE128', displayValue:false, height:mmToPx(BARCODE_MM), width:1.0, margin:0 }); return true; }catch(e){}
          }
        }
        const fallback = 'P' + String(hashCode((item && item.name) ? item.name : String(fallbackIndex))).padStart(12,'0').slice(-12);
        try{ JsBarcode(svgEl, fallback, { format:'CODE128', displayValue:false, height:mmToPx(BARCODE_MM), width:1.0, margin:0 }); return true; }catch(e){}
        return false;
      }

      // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw){
        container.innerHTML = '<p style="text-align:center;color:red;padding:12px">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©. Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª JSON ÙÙŠ localStorage Ø¨Ø§Ù„Ù…ÙØªØ§Ø­: ' + STORAGE_KEY + '</p>';
        infoEl.textContent = '';
        footerEl.textContent = '';
        return;
      }
      const payload = safeParse(raw);
      if (!payload || !Array.isArray(payload.items)){
        container.innerHTML = '<p style="text-align:center;color:red;padding:12px">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ø£Ùˆ Ù…ÙÙ‚ÙˆØ¯Ø©.</p>';
        infoEl.textContent = '';
        footerEl.textContent = '';
        return;
      }

      const items = payload.items;
      infoEl.textContent = `Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø±Ù‚Ù…: ${payload.templateNumber || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} â€” Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${items.length}`;
      footerEl.textContent = `ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(payload.generatedAt || Date.now()).toLocaleString('ar-EG')}`;

      // Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙØ­Ø§Øª
      ensureJsBarcode().catch(err => console.warn(err && err.message ? err.message : err)).finally(()=>{
        const CHUNK = ROWS * COLS; // 21
        const pages = Math.ceil(items.length / CHUNK);

        for (let p=0; p<pages; p++){
          const chunk = items.slice(p*CHUNK, p*CHUNK + CHUNK);
          const pageEl = document.createElement('section');
          pageEl.className = 'page';
          // Ø§Ù…Ù†Ø­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø±Ø¶Ù‹Ø§ Ø«Ø§Ø¨ØªÙ‹Ø§ ÙˆØ¢Ù…Ù†Ù‹Ø§ ÙˆÙ†Ø±ÙƒÙ‘Ø²Ù‡
          pageEl.style.width = (printableWidthMM) + 'mm';
          pageEl.style.marginLeft = 'auto';
          pageEl.style.marginRight = 'auto';

          const grid = document.createElement('div');
          grid.className = 'grid';
          // Ø¶Ø¨Ø· Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ§Ù„ØµÙÙˆÙ Ø¨Ø§Ù„Ù…Ù„Ù… Ø¨Ø¯Ù‚Ø© (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© safety)
          grid.style.gridTemplateColumns = `repeat(${COLS}, ${colWidthMM.toFixed(4)}mm)`;
          grid.style.gridTemplateRows = `repeat(${ROWS}, ${itemHeightMM.toFixed(4)}mm)`;
          grid.style.gap = GAP + 'mm';
          grid.style.width = `calc(${(colWidthMM * COLS).toFixed(4)}mm + ${(COLS-1)*GAP}mm)`;

          for (let i=0; i<CHUNK; i++){
            const actualIdx = p*CHUNK + i;
            const item = items[actualIdx];
            const cell = document.createElement('div');
            cell.className = 'item';
            cell.style.height = itemHeightMM.toFixed(4) + 'mm';
            cell.style.padding = ITEM_PADDING_MM + 'mm';

            if (item){
              const nameEl = document.createElement('h3');
              nameEl.className = 'name';
              nameEl.textContent = item.name || '-';
              cell.appendChild(nameEl);

              const bottom = document.createElement('div');
              bottom.className = 'bottom';

              const priceEl = document.createElement('div');
              priceEl.className = 'price';
              // Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ù…Ø¶Ù…ÙˆÙ† Ø¹Ø¨Ø± CSS var --price-mm (mm)
              priceEl.textContent = `Ø§Ù„Ø³Ø¹Ø±: ${item.price || '-'}`;
              bottom.appendChild(priceEl);

              const barcodeDiv = document.createElement('div');
              barcodeDiv.className = 'barcode';
              const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
              barcodeDiv.appendChild(svg);
              bottom.appendChild(barcodeDiv);

              cell.appendChild(bottom);
            } else {
              // Ø®Ù„ÙŠØ© ÙØ§Ø±ØºØ© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„
              const empty = document.createElement('div');
              empty.style.width = '100%';
              empty.style.height = '100%';
              empty.style.background = 'transparent';
              cell.appendChild(empty);
            }

            grid.appendChild(cell);
          }

          pageEl.appendChild(grid);
          container.appendChild(pageEl);
        }

        // Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬: Ø¶Ø¨Ø· Ø§Ù„Ù†ØµÙˆØµ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        requestAnimationFrame(()=>{
          const allCells = container.querySelectorAll('.page .grid .item');
          allCells.forEach((cell, idx) => {
            const actualIdx = idx; // ÙƒÙ„ Ø®Ù„ÙŠØ© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
            const item = items[actualIdx];
            const nameEl = cell.querySelector('.name');
            const svg = cell.querySelector('svg');

            if (nameEl){
              // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø³Ù… (px)
              const itemHpx = mmToPx(itemHeightMM);
              const priceHpx = mmToPx(PRICE_BOX_MM);
              const barcodeHpx = mmToPx(BARCODE_MM);
              const padPx = mmToPx(ITEM_PADDING_MM);
              const safetyPx = mmToPx(0.5);
              const maxNameHpx = Math.max(8, itemHpx - priceHpx - barcodeHpx - (2*padPx) - safetyPx);
              fitTextToElement(nameEl, maxNameHpx, { maxSizePx:16, minSizePx:7, step:0.5 });
              nameEl.style.maxHeight = maxNameHpx + 'px';
              nameEl.style.overflow = 'hidden';
            }

            if (svg){
              if (item){
                const ok = tryGenerateBarcode(svg, item, actualIdx);
                if (!ok){
                  svg.remove();
                  const fallback = document.createElement('div');
                  fallback.className = 'barcode-fallback';
                  fallback.textContent = (item && ((item.barcode && String(item.barcode)) || (item.scale && String(item.scale)))) || ('#' + (actualIdx + 1));
                  const barcodeDiv = cell.querySelector('.barcode');
                  if (barcodeDiv) barcodeDiv.appendChild(fallback);
                }
              } else {
                svg.remove();
              }
            }
          });
        });
      });

    })();
  </script>

  <!--
    Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ (Console):
    localStorage.setItem('print_items_v2', JSON.stringify({
      templateNumber: 1,
      generatedAt: Date.now(),
      items: Array.from({length: 22}, (_,i) => ({
        name: i%2===0 ? 'Ù…Ù†ØªØ¬ '+(i+1) : 'Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ù„ØªÙØ§Ù ÙˆØ§Ù„ØªØµØºÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ '+(i+1),
        price: (Math.random()*200).toFixed(2),
        barcode: String(6224008603764 + i)
      }))
    }));
  -->

</body>
</html>

