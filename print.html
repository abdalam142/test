<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” Ù…Ø­Ø³Ù‘ÙÙ†Ø©</title>
  <!-- JsBarcode (fallback loader in script below if CDN fails) -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <style>
    /* ØµÙØ­Ø© A4 - Ù‡ÙˆØ§Ù…Ø´ Ù…Ø·Ø¨ÙˆØ¹Ø© Ø¢Ù…Ù†Ø© */
    @page { size: A4 portrait; margin: 12mm; }

    :root{
      --item-height: 39mm; /* ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§: 297mm / 7 ØµÙÙˆÙ Ù…Ø¹ Ù‡ÙˆØ§Ù…Ø´ */
      --barcode-height: 10mm; /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø¹Ù†ØµØ± */
      --gap: 4mm;
      --font-family: Tahoma, Arial, sans-serif;
    }

    html,body{ height:100%; }
    body{
      font-family: var(--font-family);
      margin:0;
      direction: rtl;
      color: #000;
      background: #fff;
    }

    header{
      text-align:center;
      padding:8px 6mm;
      border-bottom:1px solid #d32f2f;
      margin-bottom:6px;
    }

    header h1{ font-size:16px; margin:0; }
    #templateInfo { font-size:12px; color:#444; margin-top:4px }

    .controls{ text-align:center; margin-bottom:8px }
    .controls button{
      background:#ff0800; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin:3px;
    }
    .controls button:hover{ filter:brightness(.95); }

    /* Ø´Ø¨ÙƒØ© 3 Ø£Ø¹Ù…Ø¯Ø© */
    .grid{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
      width: calc(100% - 24mm);
      margin: 0 auto 6mm auto;
      box-sizing: border-box;
    }

    .page{ page-break-after: always; }

    /* Ø¹Ù†ØµØ± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨ØµÙŠØº Ù…Ø·Ø¨ÙˆØ¹Ø© (Ø·ÙˆÙ„ Ø¨Ø§Ù„Ù…Ù„Ù…) */
    .item{
      border: 1px solid #111;
      padding: 3mm;
      height: var(--item-height);
      box-sizing: border-box;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      align-items:center;
      overflow:hidden; /* Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø© */
      background: #fff;
    }

    .info{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:0 2mm;
      box-sizing:border-box;
      /* Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø± = Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù†ØµØ± - Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ - Ø¨Ø¹Ø¶ Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Øº */
      min-height: calc(var(--item-height) - var(--barcode-height) - 6mm);
    }

    .info h3{
      margin:0;
      line-height:1.05;
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
      font-size: 14px; /* Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© - Ø³ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ */
      text-align:center;
      width:100%;
      max-width:100%;
    }

    .price{
      font-size: 11px;
      margin-top:4px;
      color:#333;
      width:100%;
    }

    .barcode{
      height: var(--barcode-height);
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
      padding-top:2mm;
    }

    .barcode svg{ width:95%; height:100%; display:block; }

    .barcode-fallback{ font-size:10px; color:#666; word-break:break-all; }

    footer{ text-align:center; font-size:11px; color:#666; margin:10px 0 }

    @media print{
      .controls, header, footer{ display:none !important }
      body{ margin:0 }
    }
  </style>
</head>
<body>
  <header>
    <h1>ØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h1>
    <div id="templateInfo"></div>
  </header>

  <div class="controls">
    <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø©</button>
    <button onclick="window.location.href='index.html'">â†©ï¸ Ø±Ø¬ÙˆØ¹</button>
  </div>

  <main id="container"></main>

  <footer>
    <div id="footerText"></div>
  </footer>

  <script>
    (function(){
      const STORAGE_KEY = 'print_items_v2';
      const container = document.getElementById('container');
      const infoEl = document.getElementById('templateInfo');
      const footerText = document.getElementById('footerText');

      function safeParse(json){ try{ return JSON.parse(json); }catch(e){ return null; } }

      // ØªØ­Ù…ÙŠÙ„ JsBarcode Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙØ­Ù…Ù‘ÙÙ„Ø§Ù‹ (ÙŠØ­Ø§ÙˆÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
      function ensureJsBarcode(){
        return new Promise((resolve, reject) => {
          if (typeof JsBarcode !== 'undefined') return resolve();
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
          s.onload = () => resolve();
          s.onerror = () => reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© JsBarcode Ù…Ù† CDN'));
          document.head.appendChild(s);
        });
      }

      // ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ø­ØªÙ‰ ÙŠØªØ³Ø¹ Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ù‚ÙŠØ§Ø³Ø§Øª Ø¨ÙŠÙƒØ³Ù„)
      function fitTextToElement(el, {maxSizePx = 16, minSizePx = 8, step = 0.5} = {}){
        if (!el) return;
        // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø±Ø¦ÙŠ ÙˆÙ…Ø¶Ø§Ù Ù„Ù„Ù€ DOM
        let computed = window.getComputedStyle(el);
        el.style.whiteSpace = 'normal';
        el.style.lineHeight = '1.05';
        let size = maxSizePx;
        el.style.fontSize = size + 'px';
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø§ØµÙŠØ© clientHeight ØµÙØ± (Ù„Ù… ÙŠÙØ¹Ø±Ø¶ Ø¨Ø¹Ø¯)ØŒ Ù†ÙØ¹Ù„ reflow
        // ØªÙƒØ±Ø§Ø± ØªÙ‚Ù„ÙŠØ¯ÙŠ Ù„Ù„ØªØµØºÙŠØ±
        while (el.scrollHeight > el.clientHeight && size > minSizePx){
          size = Math.max(minSizePx, +(size - step).toFixed(2));
          el.style.fontSize = size + 'px';
          // safety: Ø§Ø°Ø§ ÙˆØµÙ„Ù†Ø§ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù†ÙˆÙ‚Ù
          if (size <= minSizePx) break;
        }
      }

      // Ù‡Ø§Ø´ Ø¨Ø³ÙŠØ· Ù„Ø¥Ù†ØªØ§Ø¬ Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù…ÙŠØ© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
      function hashCode(str){
        let h = 0;
        for (let i=0;i<str.length;i++){ h = ((h << 5) - h) + str.charCodeAt(i); h |= 0; }
        return Math.abs(h);
      }

      // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø© ÙˆÙØ§Ù„Ø¨Ø§Ùƒ Ù†ØµÙŠ
      function generateBarcode(svgEl, item, fallbackIndex){
        if (!svgEl) return false;
        const candidates = [];
        if (item.barcode) candidates.push(String(item.barcode));
        if (item.scale) candidates.push(String(item.scale));
        if (item.sku) candidates.push(String(item.sku));
        if (item.id) candidates.push(String(item.id));

        // Ø¬Ø±Ø¨ ÙƒÙ„ Ù…Ø±Ø´Ø­ ÙƒÙ…Ø§ Ù‡Ùˆ
        for (const c of candidates){
          try{
            JsBarcode(svgEl, c, { format: 'CODE128', displayValue: false, height: 40, width: 1.05, margin: 0 });
            return true;
          }catch(e){ /* pass */ }
        }

        // Ø­Ø§ÙˆÙ„ ØªØ¹Ù‚ÙŠÙ… Ø§Ù„Ù†Øµ Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ non-ASCII (Code128 ÙŠØ¯Ø¹Ù… ASCII ÙÙ‚Ø·)
        for (const c of candidates){
          const ascii = c.replace(/[^\x00-\x7F]/g, '');
          if (!ascii) continue;
          try{
            JsBarcode(svgEl, ascii, { format: 'CODE128', displayValue: false, height: 40, width: 1.05, margin:0 });
            return true;
          }catch(e){ /* pass */ }
        }

        // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø±Ù‚Ù…ÙŠ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù…Ø³Ø­ (Ù„ÙŠØ³ Ù…Ø«Ø§Ù„ÙŠØ§Ù‹ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„ÙƒÙ† ÙŠØ¹Ù…Ù„ ÙƒÙ€ fallback)
        const fallback = 'P' + String(hashCode(item.name || String(fallbackIndex))).padStart(12, '0').slice(-12);
        try{
          JsBarcode(svgEl, fallback, { format: 'CODE128', displayValue: false, height: 40, width: 1.05, margin:0 });
          return true;
        }catch(e){ /* pass */ }

        // Ø¥Ø°Ø§ ÙØ´Ù„Ù†Ø§ ØªÙ…Ø§Ù…Ù‹Ø§ Ù†Ø­Ø°Ù Ø§Ù„Ù€ SVG ÙˆÙ†Ø¹Ø±Ø¶ Ù†ØµÙ‹Ø§ Ø¨Ø¯ÙŠÙ„Ù‹Ø§
        return false;
      }

      // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: { templateNumber, items: [{ name, price, barcode, ...}, ...], generatedAt }
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw){
        container.innerHTML = '<p style="text-align:center;color:red;padding:12px">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©. Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª JSON ÙÙŠ localStorage Ø¨Ø§Ù„Ù…ÙØªØ§Ø­: ' + STORAGE_KEY + '</p>';
        return;
      }

      const payload = safeParse(raw);
      if (!payload || !Array.isArray(payload.items)){
        container.innerHTML = '<p style="text-align:center;color:red;padding:12px">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ø£Ùˆ Ù…ÙÙ‚ÙˆØ¯Ø©.</p>';
        return;
      }

      const items = payload.items;
      infoEl.textContent = `Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø±Ù‚Ù…: ${payload.templateNumber || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} â€” Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${items.length}`;
      footerText.textContent = `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙØ­Ø© ÙÙŠ: ${new Date(payload.generatedAt || Date.now()).toLocaleString('ar-EG')}`;

      // Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ JsBarcode Ø«Ù… Ù†ØªØ§Ø¨Ø¹ØŒ Ù„ÙƒÙ† Ø¥Ù† ÙØ´Ù„ ÙØ§Ù„Ù€ barcode Ø³ÙŠØ¸Ù‡Ø± ÙƒÙ†Øµ Ø¨Ø¯ÙŠÙ„
      ensureJsBarcode().catch((err) => {
        console.warn(err && err.message ? err.message : err);
      }).finally(() => {
        // ØªÙ‚Ø³ÙŠÙ… Ø¥Ù„Ù‰ ØµÙØ­Ø§Øª: 21 Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„ØµÙØ­Ø© (7 ØµÙÙˆÙ Ã— 3 Ø£Ø¹Ù…Ø¯Ø©)
        const chunkSize = 21;
        const pages = Math.ceil(items.length / chunkSize);

        for (let p = 0; p < pages; p++){
          const chunk = items.slice(p * chunkSize, p * chunkSize + chunkSize);
          const page = document.createElement('section');
          page.className = 'page';
          const grid = document.createElement('div');
          grid.className = 'grid';

          chunk.forEach((item, localIdx) => {
            const div = document.createElement('div');
            div.className = 'item';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'info';

            const nameEl = document.createElement('h3');
            nameEl.textContent = item.name || '-';
            infoDiv.appendChild(nameEl);

            const priceEl = document.createElement('div');
            priceEl.className = 'price';
            priceEl.textContent = `Ø§Ù„Ø³Ø¹Ø±: ${item.price || '-'}`;
            infoDiv.appendChild(priceEl);

            div.appendChild(infoDiv);

            const barcodeDiv = document.createElement('div');
            barcodeDiv.className = 'barcode';
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            barcodeDiv.appendChild(svg);
            div.appendChild(barcodeDiv);

            grid.appendChild(div);
          });

          page.appendChild(grid);
          container.appendChild(page);

          // Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù€ DOM - Ù†Ø¶Ø¨Ø· Ø§Ù„Ø®Ø· ÙˆÙ†ÙˆÙ„Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„ÙƒÙ„ Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
          const itemsOnPage = grid.querySelectorAll('.item');
          itemsOnPage.forEach((div, li) => {
            const idxGlobal = p * chunkSize + li;
            const item = items[idxGlobal];
            const nameEl = div.querySelector('h3');
            const priceEl = div.querySelector('.price');

            // Ù†Ø¬Ø±Ø¨ ØªØµØºÙŠØ± Ø§Ù„Ù†Øµ Ù„ÙŠÙ„Ø§Ø¦Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©
            // Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© = infoDiv.clientHeight - price height ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§
            fitTextToElement(nameEl, { maxSizePx: 16, minSizePx: 8, step: 0.5 });

            const svg = div.querySelector('svg');
            const ok = (typeof JsBarcode !== 'undefined') ? generateBarcode(svg, item, idxGlobal) : false;
            if (!ok){
              // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ù€ SVG Ù†Ø¹Ø±Ø¶ Ù†ØµÙ‹Ø§ Ø¨Ø¯ÙŠÙ„Ù‹Ø§ Ù„Ù„Ù€ barcode
              svg.remove();
              const fallback = document.createElement('div');
              fallback.className = 'barcode-fallback';
              fallback.textContent = (item.barcode && String(item.barcode).trim()) || (item.scale && String(item.scale)) || ('#' + String(idxGlobal + 1));
              div.querySelector('.barcode').appendChild(fallback);
            }
          });
        }

      });

    })();
  </script>

  <!-- ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø© (ÙŠÙ…ÙƒÙ† Ù„ØµÙ‚Ù‡Ø§ Ø¨Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù‚Ø¨Ù„ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©):
    localStorage.setItem('print_items_v2', JSON.stringify({
      templateNumber: 1,
      generatedAt: Date.now(),
      items: [
        { name: 'Ù…Ù†ØªØ¬ Ø¨Ø·ÙˆÙ„ Ø§Ø³Ù… Ù‚ØµÙŠØ±', price: '15.00', barcode: '6224008603764' },
        { name: 'Ù…Ù†ØªØ¬ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ù‹Ø§ Ø¬Ø¯Ù‹Ø§ Ø¬Ø¯Ù‹Ø§ Ù„ÙØ±Ø¶ Ø§Ù„ØªÙØ§Ù Ø§Ù„Ø³Ø·Ø± ÙˆØ§Ù„ØªØµØºÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­ØªÙ‰ ÙŠØ¸Ù‡Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù‚Ø·Ø¹', price: '120.00', barcode: '6221024992513' }
        // ... Ø£Ø¶Ù Ø­ØªÙ‰ 21 Ø¹Ù†ØµØ±Ù‹Ø§ Ø£Ùˆ Ø£ÙƒØ«Ø±
      ]
    }));
  -->

</body>
</html>
