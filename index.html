<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” 3Ã—7 Ø«Ø§Ø¨Øª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #0b1220; color: #e6eef8; }
    header { background: #071024; }
    main { padding: 16px; }
    .print-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .card { background: #ffffff; color: #0b1220; border-radius: 6px; padding: 6px; box-sizing: border-box;
            display:flex; flex-direction:column; align-items:center; justify-content:space-between;
            width:100%; height:36mm; overflow:hidden; }
    .card .title { font-weight:700; text-align:center; line-height:1.05; width:100%; }
    .card .price { font-size:13px; color:#374151; }
    .qr-wrap { width:100%; display:flex; align-items:center; justify-content:center; }
    .barcode-svg { width:80%; height:38px; }
    @media print {
      body { background: white; color: black; }
      header, .controls, #scannerArea, #productsSection, #receivedSection { display:none !important; }
      .print-modal { position: static; width:100%; }
      .card { page-break-inside: avoid; -webkit-print-color-adjust: exact; }
    }
    .muted { color:#9aa6b2; }
    .table-scroll { max-height:60vh; overflow:auto; }
    @media (max-width: 900px) {
      .print-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body class="min-h-screen">
  <header class="p-4 flex items-center justify-between border-b border-slate-800">
    <h1 class="text-xl text-blue-400 font-semibold">Ù†Ø¸Ø§Ù… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” Ø«Ø§Ø¨Øª 3Ã—7</h1>
    <div class="flex gap-2 items-center">
      <button id="openScanner" class="bg-blue-600 px-3 py-2 rounded-md text-sm">ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button id="toggleHideEmpty" class="bg-amber-600 px-3 py-2 rounded-md text-sm">ğŸ§¾ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙØ§Ø±Øº</button>
      <button id="clearReceived" class="bg-red-600 px-3 py-2 rounded-md text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</button>
    </div>
  </header>

  <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-black/75">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p id="loadingText" class="text-gray-300">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>
  </div>

  <main class="flex gap-4 p-4">
    <section id="productsSection" class="w-1/2 bg-slate-900 p-4 rounded-md">
      <div class="flex gap-2 mb-4 items-center">
        <input id="searchInput" class="flex-1 p-2 rounded-md bg-slate-800 border border-slate-700" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..." />
        <button id="searchBtn" class="bg-blue-600 px-3 py-2 rounded-md">Ø¨Ø­Ø«</button>
        <input id="fileInput" type="file" accept=".xlsx,.xls" class="hidden" />
        <button id="needUpload" class="bg-yellow-600 px-3 py-2 rounded-md hidden">Ø±ÙØ¹ Ù…Ù„Ù</button>
      </div>
      <div class="table-scroll">
        <table class="w-full text-sm table-auto">
          <thead class="text-slate-300 sticky top-0 bg-slate-900">
            <tr><th class="p-2">Ø§Ø³Ù…</th><th class="p-2">Ø³Ø¹Ø±</th><th class="p-2">Ø§Ù„ÙˆØµÙ</th><th class="p-2">Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th class="p-2">Ø§Ø³ØªÙ„Ø§Ù…</th></tr>
          </thead>
          <tbody id="productsTbody" class="text-slate-100"></tbody>
        </table>
      </div>
    </section>

    <section id="receivedSection" class="w-1/2 bg-slate-900 p-4 rounded-md">
      <h2 class="text-lg mb-2">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</h2>
      <div class="table-scroll mb-4">
        <table class="w-full text-sm table-auto">
          <thead class="text-slate-300 bg-slate-900"><tr><th class="p-2">Ø§Ø³Ù…</th><th class="p-2">Ø³Ø¹Ø±</th><th class="p-2">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th class="p-2">ÙƒÙ…ÙŠØ©</th><th class="p-2">ØªØ­ÙƒÙ…</th></tr></thead>
          <tbody id="receivedTbody" class="text-slate-100"></tbody>
        </table>
      </div>
      <div class="flex justify-between items-center">
        <div class="flex gap-2">
          <button id="exportBtn" class="bg-green-600 px-3 py-2 rounded-md">ğŸ’¾ ØªØµØ¯ÙŠØ± Excel</button>
          <button id="previewBtn" class="bg-blue-600 px-3 py-2 rounded-md">ğŸ–¨ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
        <div class="muted text-sm">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‘Ù‹Ø§</div>
      </div>
    </section>
  </main>

  <div id="scannerArea" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/70 p-6">
    <div class="bg-slate-900 rounded-md p-4 w-full max-w-3xl">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg">ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø³Ø­</h3>
        <button id="closeScanner" class="bg-red-600 px-3 py-1 rounded-md">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div id="videoContainer" class="w-full h-96 bg-black rounded-md overflow-hidden"></div>
      <div class="text-sm muted mt-2">Ø³ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø·Ø§Ø¨Ù‚.</div>
    </div>
  </div>

  <div id="previewArea" class="hidden fixed inset-0 z-50 bg-black/80 p-6 overflow-auto">
    <div class="max-w-[900px] mx-auto bg-slate-800 p-4 rounded-md print-modal">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© â€” 3 Ã— 7 Ø«Ø§Ø¨ØªØ©</h2>
        <div class="flex gap-2">
          <button id="printNow" class="bg-green-600 px-3 py-2 rounded-md">Ø·Ø¨Ø§Ø¹Ø©</button>
          <button id="closePreview" class="bg-red-600 px-3 py-2 rounded-md">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div id="printGrid" class="print-grid"></div>
      <div class="mt-4 text-sm muted">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ÙØ§Ø±ØºØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ 21 Ø®Ø§Ù†Ø©.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

  <script>
// main script: reads Excel, manages UI, generates linear barcodes, prints fixed 3x7 grid, camera scanning.
(() => {
  'use strict';
  const STORAGE_KEY = 'selected_products_v1';

  const loading = document.getElementById('loading');
  const loadingText = document.getElementById('loadingText');
  const productsTbody = document.getElementById('productsTbody');
  const receivedTbody = document.getElementById('receivedTbody');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const openScanner = document.getElementById('openScanner');
  const closeScanner = document.getElementById('closeScanner');
  const scannerArea = document.getElementById('scannerArea');
  const videoContainer = document.getElementById('videoContainer');
  const previewArea = document.getElementById('previewArea');
  const previewBtn = document.getElementById('previewBtn');
  const closePreview = document.getElementById('closePreview');
  const printGrid = document.getElementById('printGrid');
  const printNow = document.getElementById('printNow');
  const exportBtn = document.getElementById('exportBtn');
  const toggleHideEmpty = document.getElementById('toggleHideEmpty');
  const clearReceived = document.getElementById('clearReceived');
  const fileInput = document.getElementById('fileInput');
  const needUpload = document.getElementById('needUpload');

  let products = [];
  let hideEmpty = false;
  let scanning = false;
  let stream = null;
  let detector = null;

  function showLoading(msg='Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...') { loading.style.display='flex'; loadingText.textContent=msg; }
  function hideLoading(){ loading.style.display='none'; }

  function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function loadSelected(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch(e){ return []; } }
  function saveSelected(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

  function renderProducts(filter='') {
    productsTbody.innerHTML='';
    const q = String(filter||'').trim();
    const frag = document.createDocumentFragment();
    products.forEach(p => {
      if(hideEmpty && !p.desc) return;
      if(q) {
        const nm = String(p.name||'').toLowerCase();
        const bar = String(p.barcode||'');
        if(!(nm.includes(q.toLowerCase()) || bar === q)) return;
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-2 border border-slate-700">${escapeHtml(p.name)}</td>
        <td class="p-2 border border-slate-700">${escapeHtml(p.price)}</td>
        <td class="p-2 border border-slate-700">${escapeHtml(p.desc)}</td>
        <td class="p-2 border border-slate-700">${escapeHtml(p.barcode)}</td>
        <td class="p-2 border border-slate-700"><button class="receiveBtn bg-emerald-600 px-2 py-1 rounded-md" data-id="${p.id}">Ø§Ø³ØªÙ„Ø§Ù…</button></td>
      `;
      frag.appendChild(tr);
    });
    productsTbody.appendChild(frag);
    productsTbody.querySelectorAll('.receiveBtn').forEach(btn=> btn.addEventListener('click', ()=> promptReceive(Number(btn.dataset.id))));
    if(q) {
      const found = products.find(x => x.barcode === q);
      if(found) promptReceive(found.id);
    }
  }

  function renderReceived() {
    receivedTbody.innerHTML='';
    const arr = loadSelected();
    const frag = document.createDocumentFragment();
    arr.forEach((it, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-2 border border-slate-700">${escapeHtml(it.name)}</td>
        <td class="p-2 border border-slate-700">${escapeHtml(it.price)}</td>
        <td class="p-2 border border-slate-700">${escapeHtml(it.barcode)}</td>
        <td class="p-2 border border-slate-700">${escapeHtml(it.qty)}</td>
        <td class="p-2 border border-slate-700"><button class="delRec bg-red-600 px-2 py-1 rounded-md" data-idx="${idx}">Ø­Ø°Ù</button></td>
      `;
      frag.appendChild(tr);
    });
    receivedTbody.appendChild(frag);
    receivedTbody.querySelectorAll('.delRec').forEach(b=> b.addEventListener('click', ()=> removeReceived(Number(b.dataset.idx))));
  }

  function addToReceived(prod, qty) {
    if(!prod) return;
    const n = Number(qty); if(Number.isNaN(n) || n<=0) return alert('Ø§Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
    const arr = loadSelected();
    const ex = arr.find(x=>x.barcode === prod.barcode);
    if(ex) ex.qty = (Number(ex.qty)||0) + n; else arr.push({ name: prod.name, price: prod.price, barcode: prod.barcode, qty: n });
    saveSelected(arr); renderReceived();
  }

  function promptReceive(id) {
    const p = products.find(x=>x.id === id);
    if(!p) return alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    const qty = prompt('Ø§Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø³ØªÙ„Ù…:\n' + p.name, '1');
    if(qty === null) return;
    addToReceived(p, qty);
  }

  function removeReceived(i) { const arr = loadSelected(); arr.splice(i,1); saveSelected(arr); renderReceived(); }

  exportBtn.addEventListener('click', ()=> {
    const arr = loadSelected(); if(!arr.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
    const ws = XLSX.utils.json_to_sheet(arr);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'received');
    const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    const blob = new Blob([wbout], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'received_products.xlsx'; a.click(); URL.revokeObjectURL(url);
  });

  previewBtn.addEventListener('click', ()=> {
    const arr = loadSelected(); if(!arr.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
    openPreview(arr);
  });
  closePreview.addEventListener('click', ()=> previewArea.classList.add('hidden'));
  printNow.addEventListener('click', ()=> window.print());

  function openPreview(arr) {
    printGrid.innerHTML='';
    const slots = 21;
    for(let i=0;i<slots;i++) {
      const card = document.createElement('div'); card.className = 'card';
      if(i < arr.length) {
        const it = arr[i];
        card.innerHTML = `
          <div class="title" data-text="${escapeHtml(it.name)}">${escapeHtml(it.name)}</div>
          <div class="price">Ø³Ø¹Ø±: ${escapeHtml(it.price)}</div>
          <div class="qr-wrap" data-value="${escapeHtml(it.barcode)}"></div>
          <div class="muted text-xs">${escapeHtml(it.barcode)}</div>
        `;
      } else {
        card.innerHTML = `<div style="height:100%;width:100%"></div>`;
      }
      printGrid.appendChild(card);
    }
    setTimeout(()=>{
      document.querySelectorAll('.qr-wrap').forEach(holder => {
        const v = holder.dataset.value;
        holder.innerHTML = '<svg class="barcode-svg"></svg>';
        if(v) {
          try { JsBarcode(holder.querySelector('svg'), v, { format: 'CODE128', displayValue: false, height: 36, margin:0 }); } catch(e) { holder.textContent = v; }
        }
      });
      document.querySelectorAll('.card .title').forEach(el => { fitText(el, 18, 8); });
    }, 120);
    previewArea.classList.remove('hidden');
    previewArea.scrollTop = 0;
  }

  function fitText(el, startPx=18, minPx=8) {
    el.style.fontSize = startPx + 'px';
    while((el.scrollHeight > el.clientHeight) && parseFloat(el.style.fontSize) > minPx) {
      el.style.fontSize = (parseFloat(el.style.fontSize) - 1) + 'px';
      if(parseFloat(el.style.fontSize) <= minPx) break;
    }
  }

  async function startScanner() {
    if(scanning) return;
    scanning = true; scannerArea.classList.remove('hidden');
    videoContainer.innerHTML='';
    try {
      if('BarcodeDetector' in window) {
        const formats = ['code_128','ean_13','ean_8','upc_e','code_39'];
        detector = new BarcodeDetector({ formats });
        const video = document.createElement('video');
        video.setAttribute('playsinline','true');
        video.style.width='100%'; video.style.height='100%';
        videoContainer.appendChild(video);
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream; await video.play();
        const detectLoop = async ()=>{
          if(!scanning) return;
          try {
            const results = await detector.detect(video);
            if(results && results.length) { handleScanned(results[0].rawValue); return; }
          } catch(e) {}
          requestAnimationFrame(detectLoop);
        };
        detectLoop();
        return;
      }
    } catch(e) {}
    if(typeof Quagga === 'undefined') { alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… BarcodeDetector ÙˆÙ„Ø§ Quagga Ù…ØªØ§Ø­.'); stopScanner(); return; }
    try { Quagga.init({ inputStream:{name:'Live',type:'LiveStream',target:videoContainer,constraints:{facingMode:'environment'}}, decoder:{readers:['code_128_reader','ean_reader','ean_8_reader','code_39_reader','upc_reader','upc_e_reader']}, locate:true }, function(err){ if(err){ alert('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø§Ø³Ø­'); stopScanner(); return; } Quagga.start(); }); Quagga.onDetected(res=>{ if(res && res.codeResult && res.codeResult.code) handleScanned(res.codeResult.code); }); } catch(e){ alert('Ø®Ø·Ø£ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­'); stopScanner(); }
  }

  function handleScanned(code) { stopScanner(); searchInput.value = code; const found = products.find(p=>p.barcode === code); if(found) promptReceive(found.id); else renderProducts(code); }
  function stopScanner() { scanning=false; scannerArea.classList.add('hidden'); try{ if(stream && stream.getTracks) stream.getTracks().forEach(t=>t.stop()); }catch(e){} stream=null; detector=null; try{ if(typeof Quagga!=='undefined'){ Quagga.stop(); Quagga.offDetected && Quagga.offDetected(); } }catch(e){} videoContainer.innerHTML=''; }
  openScanner.addEventListener('click', ()=> { scanning ? stopScanner() : startScanner(); });
  closeScanner.addEventListener('click', ()=> stopScanner());

  async function autoLoad() {
    showLoading('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ products.xlsx ...');
    try { const res = await fetch('./products.xlsx'); if(!res.ok) throw new Error('not found'); const ab = await res.arrayBuffer(); readWorkbook(ab); } catch(e){ document.getElementById('needUpload').classList.remove('hidden'); fileInput.classList.remove('hidden'); hideLoading(); }
  }
  fileInput.addEventListener('change', async (ev)=> { const f = ev.target.files && ev.target.files[0]; if(!f) return; showLoading('Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...'); const ab = await f.arrayBuffer(); readWorkbook(ab); });

  function readWorkbook(arrayBuffer) {
    try {
      const wb = XLSX.read(arrayBuffer, { type:'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header:1 });
      products = [];
      for(let i=0;i<rows.length;i++) {
        const r = rows[i]; if(!r || r.length===0) continue;
        const name = r[0] ? String(r[0]).trim() : '';
        const price = r[1] !== undefined ? r[1] : '';
        const desc = r[2] ? String(r[2]).trim() : '';
        const barcode = r[3] ? String(r[3]).trim() : '';
        if(!name && !price && !desc && !barcode) continue;
        products.push({ id:i, name, price, desc, barcode });
      }
      renderProducts();
    } catch(e) { alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel: ' + (e.message||e)); } finally { hideLoading(); }
  }

  window.addEventListener('DOMContentLoaded', ()=> { renderReceived(); autoLoad(); });
  searchBtn.addEventListener('click', ()=> renderProducts(searchInput.value||''));
  searchInput.addEventListener('keydown', (e)=> { if(e.key==='Enter'){ e.preventDefault(); renderProducts(searchInput.value||''); } });
  toggleHideEmpty.addEventListener('click', ()=> { hideEmpty = !hideEmpty; toggleHideEmpty.textContent = hideEmpty ? 'ğŸ§¾ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„' : 'ğŸ§¾ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙØ§Ø±Øº'; renderProducts(searchInput.value||''); });
  clearReceived.addEventListener('click', ()=> { if(confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©ØŸ')){ localStorage.removeItem(STORAGE_KEY); renderReceived(); } });

  // show/hide loading helper (placed here to avoid hoisting issues)
  function showLoading(msg='Ø¬Ø§Ø±ÙŠ...'){ loading.style.display='flex'; loadingText.textContent=msg; }
  function hideLoading(){ loading.style.display='none'; }

})();</script>

</body>
</html>
